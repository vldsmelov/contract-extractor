name: contract_extractor

services:
  api:
    image: contract-extractor/api:dev
    build:
      context: ./api
      dockerfile: dockerfile
      args:
        BASE_IMAGE: ${API_BASE_IMAGE:-contract-extractor/api-base:cu130}
    container_name: contract-extractor-api
    environment:
      - MODEL=${MODEL:-krith/qwen2.5-32b-instruct:IQ4_XS}
      - TEMPERATURE=${TEMPERATURE:-0.1}
      - MAX_TOKENS=${MAX_TOKENS:-1024}
      - NUMERIC_TOLERANCE=${NUMERIC_TOLERANCE:-0.01}
      - USE_LLM=${USE_LLM:-true}
      - API_PORT=${API_PORT:-8080}
    volumes:
      - ./api:/workspace/api
    working_dir: /workspace/api
    command: uvicorn app.main:app --host 0.0.0.0 --port 8080 --reload --log-level info
    network_mode: host
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:8080/healthz >/dev/null || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 20
    restart: unless-stopped
